<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Memory Game ‚Äî fixed shake & precise timer</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; transition: background 0.35s, color 0.35s; }
body { font-family: 'Poppins', sans-serif; min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:20px; }

/* THEMES */
body.dark { background: radial-gradient(circle at top left, #6a11cb, #2575fc); color:#fff; }
body.light { background: radial-gradient(circle at top left, #f9f9f9, #ececec); color:#333; }

h1 { margin:20px 0; font-weight:700; text-shadow:2px 2px 8px rgba(0,0,0,0.25); font-size:2.2rem; }

.controls { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; justify-content:center; }
select, button { padding:10px 14px; border-radius:8px; border:none; font-size:1rem; cursor:pointer; transition:0.2s; }
select { background: rgba(255,255,255,0.95); color:#222; }
button { background:#ff4081; color:#fff; box-shadow:0 4px 10px rgba(0,0,0,0.2); }
button:hover { transform:translateY(-2px); }
.theme-toggle { background:transparent; font-size:1.4rem; border:none; cursor:pointer; color:inherit; }

/* info */
.game-info { font-size:1.05rem; background: rgba(0,0,0,0.18); padding:8px 12px; border-radius:10px; margin-bottom:14px; display:flex; gap:12px; }
body.light .game-info { background: rgba(0,0,0,0.06); }

/* board */
.game-board { display:grid; gap:10px; width:90vmin; max-width:900px; }

/* card */
.card { position:relative; perspective:1000px; cursor:pointer; }
.card-inner { position:relative; width:100%; padding-top:100%; transform-style:preserve-3d; transition: transform 0.5s; -webkit-transform-style: preserve-3d; }
.card.flipped .card-inner { transform: rotateY(180deg); }

.card-face {
  position:absolute; top:0; left:0; width:100%; height:100%;
  border-radius:12px; display:flex; align-items:center; justify-content:center;
  font-size: clamp(1.5rem, 3vmin, 3rem);
  -webkit-backface-visibility: hidden; backface-visibility: hidden;
  box-shadow: 0 5px 15px rgba(0,0,0,0.22);
}

.card-front { background: linear-gradient(45deg, #ff7e5f, #feb47b); }
.card-back { background: #fff; color:#222; transform: rotateY(180deg); }

/* –£–±–∏—Ä–∞–µ–º visibility-—Ç—Ä—é–∫–∏ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø—É—Ç–µ–º –≤—Ä–∞—â–µ–Ω–∏—è (rotateY) */
.card.matched .card-back {
  background: linear-gradient(45deg,#00c9ff,#92fe9d);
  color:#000;
  animation: glow 1s ease;
}

@keyframes glow { 0%{box-shadow:0 0 5px #00ffcc} 50%{box-shadow:0 0 30px #00ffcc} 100%{box-shadow:0 0 5px #00ffcc} }

/* üîÑ –ü–æ–∫–∞—á–∏–≤–∞–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ —Ç–µ–ø–µ—Ä—å –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ .card (–≤–Ω–µ—à–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç) ‚Äî –Ω–µ –ª–æ–º–∞–µ—Ç rotateY */
@keyframes shake {
  0% { transform: translateX(0); }
  25% { transform: translateX(-6px); }
  50% { transform: translateX(6px); }
  75% { transform: translateX(-4px); }
  100% { transform: translateX(0); }
}
.card.shake { animation: shake 0.4s ease; }

.victory { animation: victoryFlash 1.5s ease; }
@keyframes victoryFlash {
  0%,100%{ background: radial-gradient(circle,#6a11cb,#2575fc); }
  50%{ background: radial-gradient(circle,#00c9ff,#92fe9d); }
}

@media (max-width:600px){ .game-info{ font-size:0.9rem; justify-content:center; } }
</style>
</head>
<body>
  <h1>üß† Memory Game Deluxe</h1>

  <div class="controls">
    <button class="theme-toggle" id="themeToggle" title="Toggle Theme">üåô</button>
    <label for="level">Level:</label>
    <select id="level">
      <option value="4">Easy (4x4)</option>
      <option value="6">Medium (6x6)</option>
      <option value="8">Hard (8x8)</option>
      <option value="10">Insane (10x10)</option>
    </select>
    <button id="restart">Restart</button>
  </div>

  <div class="game-info">
    ‚è± <span id="timer">0</span>s |
    Moves: <span id="moves">0</span> |
    Matches: <span id="matches">0</span>
  </div>

  <div class="game-board" id="gameBoard"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const gameBoard = document.getElementById('gameBoard');
  const movesDisplay = document.getElementById('moves');
  const matchesDisplay = document.getElementById('matches');
  const timerDisplay = document.getElementById('timer');
  const restartButton = document.getElementById('restart');
  const levelSelect = document.getElementById('level');
  const themeToggle = document.getElementById('themeToggle');

  let cards = [];
  let flippedCards = [];
  let moves = 0;
  let matchedPairs = 0;
  let lockBoard = false;
  let totalPairs = 8;

  // —Ç–∞–π–º–µ—Ä—ã/—Ç–∞–π–º–∞—É—Ç—ã ‚Äî —Ö—Ä–∞–Ω–∏–º id —á—Ç–æ–±—ã –æ—á–∏—â–∞—Ç—å
  let revealTimeout = null;
  let hideTimeout = null;
  let timerStartTimeout = null;
  let intervalId = null;
  let startTime = 0;

  // EMOJIS (—Å –∫–æ—Ç–∏–∫–æ–º –≤–º–µ—Å—Ç–æ –ø–æ–º–∏–¥–æ—Ä–∞)
  const emojis = ['üçé','üçå','üçá','üçä','üçì','üçí','üçë','üçç','ü•ù','üçâ','ü••','üçã','üçà','üçè','üçê','ü•ï','üê±','üåΩ','ü•¶','üßÑ','üßÖ','ü•î','üç†','üçû','ü•®','üßÄ','üçó','üçñ','üç§','üç£','üçï','üçî','üçü','üå≠','ü•™','ü•ó','üçù','üç∞','üç™','üç©','üçø','üßä','üç´','üç¨','üç≠','ü•ß','ü•Æ','üçØ','‚òï','üçµ','üç∫','üç∏','üç∑','üçπ'];

  function clearTimers() {
    if (revealTimeout) { clearTimeout(revealTimeout); revealTimeout = null; }
    if (hideTimeout) { clearTimeout(hideTimeout); hideTimeout = null; }
    if (timerStartTimeout) { clearTimeout(timerStartTimeout); timerStartTimeout = null; }
    if (intervalId) { clearInterval(intervalId); intervalId = null; }
  }

  function startPreciseTimer() {
    startTime = Date.now();
    // show immediately 0
    timerDisplay.textContent = 0;
    // use a single interval to update display each second using Date.now()
    intervalId = setInterval(() => {
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      timerDisplay.textContent = elapsed;
    }, 1000);
  }

  function initGame(size = 4) {
    // clear previous timers/intervals to avoid duplicates
    clearTimers();

    // reset state
    moves = 0;
    matchedPairs = 0;
    flippedCards = [];
    cards = [];
    lockBoard = true; // –±–ª–æ–∫–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –ø–æ–∫–∞ –∏–¥—ë—Ç reveal
    movesDisplay.textContent = 0;
    matchesDisplay.textContent = 0;
    timerDisplay.textContent = 0;
    gameBoard.innerHTML = '';

    totalPairs = (size * size) / 2;

    // prepare cards
    const chosen = emojis.slice(0, totalPairs);
    const gameCards = [...chosen, ...chosen].sort(() => Math.random() - 0.5);
    gameBoard.style.gridTemplateColumns = `repeat(${size}, 1fr)`;

    gameCards.forEach(emoji => {
      const card = document.createElement('div');
      card.classList.add('card');
      card.dataset.emoji = emoji;
      card.innerHTML = `
        <div class="card-inner">
          <div class="card-face card-front">?</div>
          <div class="card-face card-back">${emoji}</div>
        </div>
      `;
      card.addEventListener('click', flipCard);
      gameBoard.appendChild(card);
      cards.push(card);
    });

    // Reveal: –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∫–∞—Ä—Ç—ã –Ω–∞ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è, –∑–∞—Ç–µ–º —Å–∫—Ä—ã—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–∞–π–º–µ—Ä.
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–ø–æ—á–∫—É —Ç–∞–π–º–∞—É—Ç–æ–≤ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Ö id, —á—Ç–æ–±—ã –ø—Ä–∏ –Ω–æ–≤–æ–º initGame –º–æ–∂–Ω–æ –±—ã–ª–æ –∏—Ö –æ—Ç–º–µ–Ω–∏—Ç—å.
    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º (—á—Ç–æ–±—ã DOM —É—Å–ø–µ–ª –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å—Å—è)
    revealTimeout = setTimeout(() => {
      cards.forEach(c => c.classList.add('flipped'));
      // —á–µ—Ä–µ–∑ 1000ms —Å–∫—Ä—ã–≤–∞–µ–º
      hideTimeout = setTimeout(() => {
        cards.forEach(c => c.classList.remove('flipped'));
        // –ø–æ—Å–ª–µ —Å–∫—Ä—ã—Ç–∏—è –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –∏ —Ä–∞–∑—Ä–µ—à–∞–µ–º –∫–ª–∏–∫–∏
        startPreciseTimer();
        lockBoard = false;
      }, 1000);
    }, 100);

  }

  function flipCard() {
    if (lockBoard) return;
    if (this.classList.contains('flipped') || this.classList.contains('matched')) return;

    this.classList.add('flipped');
    flippedCards.push(this);

    if (flippedCards.length === 2) {
      lockBoard = true;
      moves++;
      movesDisplay.textContent = moves;
      checkForMatch();
    }
  }

  function checkForMatch() {
    const [c1, c2] = flippedCards;
    const match = c1.dataset.emoji === c2.dataset.emoji;
    if (match) {
      markMatched();
    } else {
      shakeAndUnflip();
    }
  }

  function markMatched() {
    flippedCards.forEach(c => {
      c.classList.add('matched');
      c.removeEventListener('click', flipCard);
    });
    matchedPairs++;
    matchesDisplay.textContent = matchedPairs;
    resetRound();

    if (matchedPairs === totalPairs) {
      // –ø–æ–±–µ–¥–∞
      if (intervalId) { clearInterval(intervalId); intervalId = null; }
      document.body.classList.add('victory');
      setTimeout(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        alert(`üéâ You won in ${moves} moves and ${elapsed}s!`);
        document.body.classList.remove('victory');
      }, 500);
    }
  }

  function shakeAndUnflip() {
    // –¥–æ–±–∞–≤–ª—è–µ–º shake –∫ –≤–Ω–µ—à–Ω–µ–π –∫–∞—Ä—Ç–æ—á–∫–µ, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å .card-inner transform
    flippedCards.forEach(c => c.classList.add('shake'));

    // –ø–æ–¥–æ–∂–¥—ë–º, –ø–æ–∫–∞ animation –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è (0.4s), –∑–∞—Ç–µ–º —É–±—Ä–∞—Ç—å shake –∏ —Å–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—ã
    setTimeout(() => {
      flippedCards.forEach(c => {
        c.classList.remove('shake');
        c.classList.remove('flipped'); // –∑–∞–∫—Ä—ã–≤–∞–µ–º
      });
      resetRound();
    }, 420); // —á—É—Ç—å –±–æ–ª—å—à–µ —á–µ–º 0.4s, —á—Ç–æ–±—ã –∞–Ω–∏–º–∞—Ü–∏—è —É—Å–ø–µ–ª–∞ –∑–∞–∫–æ–Ω—á–∏—Ç—å—Å—è
  }

  function resetRound() {
    flippedCards = [];
    lockBoard = false;
  }

  // —Å–æ–±—ã—Ç–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
  restartButton.addEventListener('click', () => {
    initGame(parseInt(levelSelect.value));
  });
  levelSelect.addEventListener('change', () => {
    initGame(parseInt(levelSelect.value));
  });

  // THEME SWITCH
  function setTheme(mode) {
    document.body.className = mode;
    localStorage.setItem('theme', mode);
    themeToggle.textContent = mode === 'dark' ? 'üåô' : 'üåû';
  }

  themeToggle.addEventListener('click', () => {
    const current = document.body.classList.contains('dark') ? 'dark' : 'light';
    setTheme(current === 'dark' ? 'light' : 'dark');
  });

  const savedTheme = localStorage.getItem('theme') || 'dark';
  setTheme(savedTheme);

  // —Å—Ç–∞—Ä—Ç
  initGame();
});
</script>
</body>
</html>